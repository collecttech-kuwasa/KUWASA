<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer List Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 500px; }
        .custom-marker { background-color: red; border-radius: 50%; width: 10px; height: 10px; border: none; }
        .custom-customer-marker { background-color: blue; }
        .leaflet-tooltip { font-size: 10px; }
        .toggle-btn { margin-bottom: 10px; }
        #toggle-layer-btn { display: none; }
        #search-container { text-align: center; margin-bottom: 10px; }
        #customer-search-input { padding: 5px; width: 200px; margin-right: 5px; }
        #search-btn { padding: 5px; }
        #info-container, .leaflet-tooltip-custom { text-align: center; margin-bottom: 10px; }
        body { margin-bottom: 40px; }
        #current-location-info, #selected-customer-info { width: 300px; margin-bottom: 5px; }
        #made-with-love { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: red; z-index: 1000; }
        #customer-list { list-style-type: decimal; padding-left: 20px; font-size: 14px; display: none; }
        #customer-list li { font-size: 12px; }
    </style>
</head>
<body>
    <h1>KUWASA Customers</h1>
    <div id="search-container">
        <input type="text" id="customer-search-input" placeholder="Search for a customer">
        <button id="search-btn">Search</button>
    </div>
    <div id="info-container">
        <label for="current-location-info">Current Location:</label>
        <input type="text" id="current-location-info" readonly><br>
        <label for="selected-customer-info">Selected Customer:</label>
        <input type="text" id="selected-customer-info" readonly>
    </div>
    <button id="show-customer-list-btn">Show Customer List</button>
    <div id="map"></div>
    <div id="customer-list-container">
        <h2 id="customer-list-heading">Customer List</h2>
        <ul id="customer-list"></ul>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script>
        var customers = {{ customers_json | safe }};
        var nearbyCustomers, selectedCustomerInfo = document.getElementById('selected-customer-info');
        var showNames = false;

        document.addEventListener('DOMContentLoaded', function () {
            var map, currentLocationMarker, markers = [], showSatellite = false;
            var currentLocationInfo = document.getElementById('current-location-info');
            var directionsLayer, removeRouteBtn;

            // Set default map options
            var defaultZoomLevel = 14, defaultCenter = [-4.893941, 29.673386];

            map = L.map('map').setView(defaultCenter, defaultZoomLevel);
            var defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            var satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: '© Google contributors',
                maxZoom: 19,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });

            function calculateRecommendedZoomLevel(desiredFeatureSize) {
                var initialScale = 1, recommendedZoomLevel = map.getZoom();
                for (var zoomLevel = 0; zoomLevel <= 19; zoomLevel++) {
                    var scale = initialScale / Math.pow(2, zoomLevel);
                    var featureSizeInPixels = desiredFeatureSize / scale;
                    if (featureSizeInPixels >= 1) return zoomLevel;
                }
                return recommendedZoomLevel;
            }

            function showCustomersAround(currentLocation, showNames) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                var currentLayer = showSatellite ? satelliteLayer : defaultLayer;
                map.addLayer(currentLayer);
                var radius = 15000;
                var nearbyCustomers = customers.filter(customer => calculateDistance(
                    currentLocation.lat, currentLocation.lng,
                    customer.latitude, customer.longitude) <= radius);
                nearbyCustomers.forEach((customer, index) => {
                    var customerMarker = L.marker([customer.latitude, customer.longitude], {
                        icon: L.divIcon({ className: 'custom-customer-marker', html: '<div class="leaflet-div-icon"></div>', iconSize: [10, 10], iconAnchor: [5, 5] })
                    }).bindPopup(getCustomerPopupContent(customer)).on('click', function (e) {
                        var clickedMarker = e.target, clickedCoords = clickedMarker.getLatLng();
                        selectedCustomerInfo.value = `Latitude: ${clickedCoords.lat.toFixed(6)}, Longitude: ${clickedCoords.lng.toFixed(6)}`;
                    });
                    if (showNames) customerMarker.bindTooltip(customer.customername, { permanent: true, direction: 'auto', className: 'leaflet-tooltip-custom' });
                    markers.push(customerMarker);
                    customerMarker.addTo(map);
                });
                currentLocationInfo.value = `Latitude: ${currentLocation.lat.toFixed(6)}, Longitude: ${currentLocation.lng.toFixed(6)}`;
                
                // Show or hide the customer list heading based on results
                var customerListHeading = document.getElementById('customer-list-heading');
                if (nearbyCustomers.length > 0) {
                    customerListHeading.style.display = 'block';
                } else {
                    customerListHeading.style.display = 'none';
                }

                // Update the customer list
                updateCustomerList(nearbyCustomers);
            }

            var defaultLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            var satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: '© Google contributors',
                maxZoom: 19,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            });

            var baseLayers = { "OpenStreetMap": defaultLayer, "Satellite": satelliteLayer };

            L.control.layers(baseLayers).addTo(map);

            var toggleLayerBtn = document.getElementById('toggle-layer-btn');
            toggleLayerBtn.addEventListener('click', function () {
                showSatellite = !showSatellite;
                map.removeLayer(currentLocationMarker);
                showCurrentLocation();
                showCustomersAround(currentLocationMarker.getLatLng(), showNames);
            });

            var searchBtn = document.getElementById('search-btn');
            searchBtn.addEventListener('click', function () {
                var searchInput = document.getElementById('customer-search-input');
                var customerName = searchInput.value.trim().toLowerCase();
                var foundCustomer = customers.find(customer => customer.customername.toLowerCase() === customerName);
                if (foundCustomer) {
                    var customerLocation = L.latLng(foundCustomer.latitude, foundCustomer.longitude);
                    map.setView(customerLocation, calculateRecommendedZoomLevel(30));
                    var customerMarker = L.marker(customerLocation);
                    customerMarker.addTo(map);
                    customerMarker.bindPopup(getCustomerPopupContent(foundCustomer)).openPopup();
                    searchInput.value = '';
                } else {
                    alert('Customer not found!');
                }
            });

            var showCustomerListBtn = document.getElementById('show-customer-list-btn');
            showCustomerListBtn.addEventListener('click', function () {
                showNames = !showNames;
                showCustomersAround(currentLocationMarker.getLatLng(), showNames);
            });

            function showCurrentLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var currentLocation = L.latLng(position.coords.latitude, position.coords.longitude);
                        currentLocationMarker = L.marker(currentLocation, { icon: L.divIcon({ className: 'custom-marker' }) });
                        currentLocationMarker.addTo(map);
                        currentLocationMarker.bindTooltip('You are here!', { permanent: true, direction: 'auto' });
                        showCustomersAround(currentLocation, showNames);
                    });
                } else {
                    alert('Geolocation is not supported by your browser. Please enable location services.');
                }
            }

            showCurrentLocation();

            L.DomEvent.disableClickPropagation(L.DomEvent.on(currentLocationMarker, 'click', function () {
                map.setView(currentLocationMarker.getLatLng(), calculateRecommendedZoomLevel(30));
                currentLocationMarker.openPopup();
            }));

            map.on('click', function (e) {
                var clickedLocation = e.latlng;
                var distanceToClickedLocation = calculateDistance(
                    currentLocationMarker.getLatLng().lat, currentLocationMarker.getLatLng().lng,
                    clickedLocation.lat, clickedLocation.lng
                );
                alert(`Distance to clicked location: ${distanceToClickedLocation.toFixed(2)} meters`);
            });

            function updateCustomerList(nearbyCustomers) {
                var maxCustomersToShow = 5;
                var customerList = document.getElementById('customer-list');
                customerList.innerHTML = ''; // Clear existing list
                nearbyCustomers.slice(0, maxCustomersToShow).forEach(function (customer, index) {
                    var listItem = document.createElement('li');
                    var distance = calculateDistance(
                        currentLocationMarker.getLatLng().lat, currentLocationMarker.getLatLng().lng,
                        customer.latitude, customer.longitude
                    );
    
                    // Check if distance is undefined and handle it
                    var distanceText = distance !== undefined ? `${distance.toFixed(2)}m` : 'N/A';
    
                    listItem.innerHTML = `<strong>${index + 1}. ${customer.customername}</strong> - (HN: ${customer.house_number}, ${distanceText})`;
                    customerList.appendChild(listItem);
                });

                // Show or hide the customer list based on results
                if (nearbyCustomers.length > 0) {
                    customerList.style.display = 'block';
                } else {
                    customerList.style.display = 'none';
                }
            }
        });

        // Calculate distance between two points in meters
        function calculateDistance(lat1, lon1, lat2, lon2) {
            var R = 6371e3; // Earth radius in meters
            var φ1 = toRadians(lat1);
            var φ2 = toRadians(lat2);
            var Δφ = toRadians(lat2 - lat1);
            var Δλ = toRadians(lon2 - lon1);
            var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var distance = R * c;
            return distance;
        }

        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }

        function getCustomerPopupContent(customer) {
            return `<strong>${customer.customername}</strong><br>House Number: ${customer.house_number}`;
        }
    </script>
</body>
</html>
